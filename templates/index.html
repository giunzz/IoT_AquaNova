<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>AquaNova – Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='/img/logo_aquanova.png') }}">

  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root { --brand:#0ea5e9; --muted:#6b7280; --bg:#f6f7fb; }
    body{font-family:system-ui, sans-serif; margin:0; background:var(--bg); color:#111;}
    header{display:flex;align-items:center;gap:12px; padding:14px 18px; background:var(--brand); color:#fff;}
    header h2{margin:0}
    .layout{display:grid; grid-template-columns:220px 1fr; min-height:calc(100vh - 56px);}
    aside{background:#fff; border-right:1px solid #e5e7eb; padding:16px;}
    aside .menu a{display:flex; align-items:center; gap:10px; padding:10px 12px; color:#111; text-decoration:none; border-radius:10px;}
    aside .menu a.active{background:#eef7ff; color:#0a6db2;}
    main{padding:20px;}
    .cards{display:grid; grid-template-columns:repeat(4,1fr); gap:14px; margin-bottom:16px;}
    .card{background:#fff; padding:16px; border-radius:14px; box-shadow:0 2px 12px rgba(0,0,0,.05);}
    .card h4{margin:0 0 6px 0;}
    .muted{color:var(--muted); font-size:13px;}
    .switch{width:52px; height:30px; border-radius:20px; background:#e5e7eb; position:relative; cursor:pointer;}
    .switch.on{background:#7c3aed;}
    .switch i{position:absolute; top:3px; left:3px; width:24px; height:24px; background:#fff; border-radius:50%; transition:all .2s;}
    .switch.on i{left:25px;}
    .grid2{display:grid; grid-template-columns:1.3fr 1fr; gap:16px;}
    @media (max-width:1000px){
      .layout{grid-template-columns:1fr}
      aside{display:none}
      .cards{grid-template-columns:1fr 1fr}
      .grid2{grid-template-columns:1fr}
    }
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 12px;border-bottom:1px solid #edf0f4;font-size:14px;}
    .badge{padding:4px 10px; border-radius:999px; font-size:12px; display:inline-block;}
    .badge.safe{background:#dcfce7;color:#166534;}
    .badge.alert{background:#fee2e2;color:#991b1b;}
    .btn{background:#2563eb;color:#fff;border:none;border-radius:10px;padding:10px 14px;cursor:pointer}
    .btn:disabled{opacity:.7; cursor:not-allowed}
    .right{display:flex;justify-content:flex-end;gap:8px}
  </style>
</head>
<body>
  <header>
    <h2>AquaNova</h2>
  <div style="opacity:.9; display:flex; gap:14px; align-items:center">
    <a href="{{ url_for('admin_page') }}" style="color:#fff; text-decoration:none">Admin</a>
  </div>
  </header>

  <div class="layout">
    <aside>
      <nav class="menu">
        <a class="tab-link" data-path="{{ url_for('home') }}"        href="{{ url_for('home') }}">Dashboard</a>
        <a class="tab-link" href="#">Favorites</a>
        <a class="tab-link" href="#">Chat bot</a>
        <a class="tab-link" data-path="{{ url_for('feed_timer_page') }}" href="{{ url_for('feed_timer_page') }}">Feed Timer</a>
        <a class="tab-link" data-path="{{ url_for('temperature_page') }}" href="{{ url_for('temperature_page') }}">Temperature</a>
        <a class="tab-link" data-path="{{ url_for('turbidity_page') }}"  href="{{ url_for('turbidity_page') }}">Turbidity</a>
      </nav>
    </aside>

    <main>
      <!-- CARDS -->
      <div class="cards">
        <div class="card">
          <h4>Light in fish tank</h4>
          <div id="lightSwitch" class="switch on" title="demo only"><i></i></div>
          <div class="muted" id="lightStatus">Light is turn on now</div>
        </div>

        <div class="card">
          <h4>Feed Amount</h4>
          <div style="font-size:28px;font-weight:700" id="feedPercent">--%</div>
          <div class="muted" id="feedHint">Plenty of feed available.</div>
        </div>

        <div class="card">
          <h4>Feed Now</h4>
          <button class="btn" id="feedNowBtn">Click</button>
          <div class="muted" id="feedNowMsg"></div>
        </div>

        <div class="card">
          <h4>Announce</h4>
          <div style="font-size:28px;font-weight:700" id="announceCount">0</div>
          <div class="muted"><a href="#" style="text-decoration:none;color:#16a34a">Note announce risk</a></div>
        </div>
      </div>

      <!-- CHART + TABLE -->
      <div class="grid2">
        <div class="card">
          <div class="right"><small class="muted" id="chartUpdated">—</small></div>
          <h3 style="margin:6px 0 10px">Turbidity</h3>
          <canvas id="turbChart" height="260"></canvas>
        </div>

        <div class="card">
          <div class="right"><small class="muted" id="tableUpdated">—</small></div>
          <h3 style="margin:6px 0 10px">Temperature</h3>
          <table>
            <thead>
              <tr><th>Date time</th><th>Current Temp (°C)</th><th>Safe Range (°C)</th><th>Device</th><th>Status</th></tr>
            </thead>
            <tbody id="tempRows"></tbody>
          </table>
        </div>
      </div>
    </main>
  </div>

  <!-- Script highlight tab active -->
  <script>
    (function markActive(){
      const here = location.pathname.replace(/\/+$/,'') || '/';
      document.querySelectorAll('.menu .tab-link').forEach(a=>{
        const path = (a.dataset.path || a.getAttribute("href") || "").replace(/\/+$/,'') || '/';
        if (path === here) a.classList.add('active'); else a.classList.remove('active');
      });
    })();
  </script>

  <script>
  // === LIGHT CONTROL ===
  const SAFE_MIN = 0, SAFE_MAX = 1000;
  const TURBIDITY_WARN = 200;
  const lightSwitch = document.getElementById('lightSwitch');
  const lightStatus = document.getElementById('lightStatus');

  async function toggleLight(isOn) {
    try {
      const res = await fetch('/control/light', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ light: isOn ? 1 : 0 }) // gửi 1 hoặc 0
      });

      const data = await res.json();
      if (res.ok && data.ok) {
        lightStatus.textContent = isOn
          ? 'Light is turned ON now'
          : 'Light is turned OFF';
        lightStatus.style.color = isOn ? '#166534' : '#991b1b';
      } else {
        throw new Error(data.error || 'Failed to update light');
      }
    } catch (err) {
      console.error('[LIGHT ERROR]', err);
      lightStatus.textContent = '⚠ Error controlling light';
      lightStatus.style.color = '#dc2626';
    }
  }

  lightSwitch.addEventListener('click', () => {
    const isOn = lightSwitch.classList.toggle('on');
    toggleLight(isOn);
  });
</script>


 <script>
  const feedBtn = document.getElementById('feedNowBtn');
  const feedMsg = document.getElementById('feedNowMsg');

  feedBtn.addEventListener('click', async () => {
    feedBtn.disabled = true;
    feedMsg.textContent = 'Sending...';
    try {
      const res = await fetch('/control/feed-now', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ amount: 20 })
      });
      const data = await res.json();
      if (res.ok && data.ok) {
        feedMsg.textContent = 'Feed command sent successfully!';
        feedMsg.style.color = '#166534';
      } else {
        throw new Error(data.error || 'Feed failed');
      }
    } catch (err) {
      console.error('[FEED ERROR]', err);
      feedMsg.textContent = '⚠ Error sending feed command';
      feedMsg.style.color = '#dc2626';
    } finally {
      setTimeout(() => { feedMsg.textContent = ''; }, 2500);
      feedBtn.disabled = false;
    }
  });
</script>


  <script>
    // === CHART ===
    let turbChart;
    function ensureChart(ctx, labels, data){
      if (turbChart) {
        turbChart.data.labels = labels;
        turbChart.data.datasets[0].data = data;
        turbChart.update();
        return turbChart;
      }
      turbChart = new Chart(ctx, {
        type:'line',
        data:{ labels, datasets:[{ label:'Turbidity', data, borderWidth:2, tension:.25, pointRadius:2, fill:true }]},
        options:{
          responsive:true,
          interaction:{mode:'index', intersect:false},
          scales:{ x:{title:{display:true,text:'Time (UTC)'}}, y:{title:{display:true,text:'NTU / %'}} }
        }
      });
      return turbChart;
    }

    async function loadAll(){
      // 1) bản ghi mới nhất -> thẻ Feed Amount
      const last = await (await fetch('/dashboard/last')).json();
      if (last.item){
        const fa = last.item.feed_amount ?? last.item.feed ?? null;
        if (fa!=null) {
          document.getElementById('feedPercent').textContent = `${fa}%`;
          if (fa < 10) {
            document.getElementById('feedHint').textContent = '⚠ Warning: Feed is almost empty!';
            document.getElementById('feedHint').style.color = '#dc2626'; // đỏ cảnh báo
          } else if (fa < 30) {
            document.getElementById('feedHint').textContent = 'Low feed level.';
            document.getElementById('feedHint').style.color = '#d97706'; // cam
          } else {
            document.getElementById('feedHint').textContent = 'Plenty of feed available.';
            document.getElementById('feedHint').style.color = '#6b7280'; // muted
          }
        } else {
          document.getElementById('feedPercent').textContent = '--%';
          document.getElementById('feedHint').textContent = 'No data.';
        }
      }

      // 2) announce count
      const ann = await (await fetch('/dashboard/announce-count')).json();
      document.getElementById('announceCount').textContent = ann.count ?? 0;

      // 3) latest N -> chart + table
      const latest = await (await fetch('/dashboard/latest?n=60')).json();
      const items = latest.items || [];

      // --- Chart Turbidity ---
      const arr = items.slice().reverse();
      const labels = arr.map(r => {
      const dt = new Date(r.ts || '');
      if (isNaN(dt)) return r.ts || '';
      
      // Chuyển sang múi giờ Việt Nam (UTC+7)
      dt.setHours(dt.getHours());

      // Hiển thị giờ dạng HH:MM:SS
      return dt.toLocaleTimeString('vi-VN', { hour12: false });
    });
      const turb = arr.map(r => Number(r.turbidity ?? NaN));
      ensureChart(document.getElementById('turbChart').getContext('2d'), labels, turb);
      document.getElementById('chartUpdated').textContent = 'Updated: ' + new Date().toLocaleTimeString();

      // --- Table Temperature ---
      const tbody = document.getElementById('tempRows');
      tbody.innerHTML = '';
      items.slice(0,10).forEach(r=>{
        const dt = new Date(r.ts||'');
        const ts = isNaN(dt) ? (r.ts||'') : dt.toLocaleString();
        const t = Number(r.temperature ?? r.temp ?? NaN);
        const device = r.deviceId ?? r.device_id ?? '';
        const ok = !isNaN(t) && t >= SAFE_MIN && t <= SAFE_MAX;
        const badge = `<span class="badge ${ok?'safe':'alert'}">${ok?'Safe':'Alert'}</span>`;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${ts}</td>
          <td>${isNaN(t)?'':t.toFixed(2)}</td>
          <td>${SAFE_MIN} – ${SAFE_MAX}</td>
          <td>${device}</td>
          <td>${badge}</td>`;
        tbody.appendChild(tr);
      });
      document.getElementById('tableUpdated').textContent = 'Updated: ' + new Date().toLocaleTimeString();
    }

    loadAll();
    setInterval(loadAll, 600000);
  </script>
</body>
</html>


