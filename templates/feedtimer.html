<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>AquaNova – Feed Timer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- FIX favicon path -->
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='img/logo_aquanova.png') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root { --brand:#0ea5e9; --muted:#6b7280; --bg:#f6f7fb; --ok:#16a34a; --bad:#dc2626; }
    *{box-sizing:border-box}
    body{font-family:system-ui, Arial, sans-serif; margin:0; background:var(--bg); color:#111;}
    header{display:flex;align-items:center;justify-content:space-between; gap:12px; padding:14px 18px; background:var(--brand); color:#fff;}
    header h2{margin:0; display:flex; align-items:center; gap:10px}
    header img{height:22px; width:auto}
    .layout{display:grid; grid-template-columns:220px 1fr; min-height:calc(100vh - 56px);}
    aside{background:#fff; border-right:1px solid #e5e7eb; padding:16px;}
    aside .menu a{display:block; padding:10px 12px; color:#111; text-decoration:none; border-radius:10px;}
    aside .menu a.active{background:#eef7ff; color:#0a6db2;}
    main{padding:20px; max-width:1400px}
    .card{background:#fff; padding:16px; border-radius:14px; box-shadow:0 2px 12px rgba(0,0,0,.05);}
    .grid{display:grid; grid-template-columns:1.1fr 1fr; gap:16px}
    .grid-2{display:grid; grid-template-columns:1fr 1fr; gap:16px}
    @media (max-width:1000px){ .layout{grid-template-columns:1fr} aside{display:none} .grid,.grid-2{grid-template-columns:1fr} }
    .toolbar{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
    label{font-size:13px; color:#374151; display:block; margin-bottom:6px}
    input, select{padding:9px 10px; border:1px solid #e5e7eb; border-radius:10px; background:#fff; min-width:120px}
    .btn{background:#2563eb; color:#fff; border:none; border-radius:10px; padding:10px 14px; cursor:pointer}
    .btn.secondary{background:#0ea5e9}
    .btn.ghost{background:#f3f4f6;color:#111}
    .muted{color:var(--muted); font-size:13px}
    table{width:100%; border-collapse:collapse}
    th,td{padding:10px 12px; border-bottom:1px solid #edf0f4; font-size:14px; text-align:left}
    .status{padding:4px 10px; border-radius:999px; font-size:12px; display:inline-block}
    .ok{background:#dcfce7; color:#166534}
    .bad{background:#fee2e2; color:#991b1b}
    .tag{font-size:12px; padding:2px 8px; border-radius:999px; background:#eef2ff; color:#3730a3}
  </style>
</head>
<body>
  <header>
    <h2>AquaNova</h2>
    <div style="opacity:.95; display:flex; gap:14px; align-items:center">
      <span>Feed Timer</span>
      <a href="{{ url_for('admin_page') }}" style="color:#fff; text-decoration:none">Admin</a>
    </div>
  </header>

  <div class="layout">
    <aside>
      <nav class="menu">
        <a class="tab-link" href="{{ url_for('home') }}">Dashboard</a>
        <a class="tab-link" href="{{ url_for('temperature_page') }}">Temperature</a>
        <a class="tab-link" href="{{ url_for('turbidity_page') }}">Turbidity</a>
        <a class="tab-link active" href="{{ url_for('feed_timer_page') }}">Feed Timer</a>
      </nav>
    </aside>

    <main>
      <div class="grid">
        <!-- Left: Feed Now + Schedule Form -->
        <div class="card">
          <h3 style="margin-top:0">Feeder control</h3>

          <!-- Feed Now -->
          <div class="card" style="margin-bottom:14px; padding:12px">
            <div class="toolbar">
              <div>
                <label>Device</label>
                <select id="fnDevice"></select>
              </div>
              <div>
                <label>Amount (g)</label>
                <input type="number" id="fnAmount" min="1" step="1" value="20">
              </div>
              <div style="align-self:end">
                <button class="btn" id="feedNowBtn">Feed Now</button>
              </div>
              <div class="muted" id="feedNowMsg"></div>
            </div>
          </div>

          <!-- Schedule -->
          <div class="card" style="padding:12px">
            <h4 style="margin:0 0 8px">Add schedule</h4>
            <div class="toolbar">
              <div>
                <label>Device</label>
                <select id="scDevice"></select>
              </div>
              <div>
                <label>Time</label>
                <input type="time" id="scTime" value="08:30">
              </div>
              <div>
                <label>Repeat</label>
                <select id="scRepeat">
                  <option value="once">Once</option>
                  <option value="daily" selected>Daily</option>
                  <option value="weekly">Weekly</option>
                </select>
              </div>
              <div>
                <label>Amount (g)</label>
                <input type="number" id="scAmount" min="1" step="1" value="20">
              </div>
              <div style="align-self:end">
                <button class="btn secondary" id="addScheduleBtn">Add</button>
              </div>
              <div class="muted" id="addScheduleMsg"></div>
            </div>
          </div>
        </div>

        <!-- Right: TWO DOUGHNUTS (latest feed snapshots) -->
        <div class="card">
          <h3 style="margin:0 0 10px">Latest feed snapshots</h3>
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:18px">
            <div style="text-align:center">
              <canvas id="feedPie1" width="180" height="180" style="max-width:220px;margin:auto"></canvas>
              <div style="margin-top:6px" class="muted">
                <b id="feedPie1Num">--%</b> · <span id="feedPie1Time">—</span>
                <div id="feedPie1Warn" class="tag" style="display:none;margin-top:6px">Low feed (&lt; 10%)</div>
              </div>
            </div>
            <div style="text-align:center">
              <canvas id="feedPie2" width="180" height="180" style="max-width:220px;margin:auto"></canvas>
              <div style="margin-top:6px" class="muted">
                <b id="feedPie2Num">--%</b> · <span id="feedPie2Time">—</span>
                <div id="feedPie2Warn" class="tag" style="display:none;margin-top:6px">Low feed (&lt; 10%)</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Schedules table -->
      <div class="card" style="margin-top:16px">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px">
          <h3 style="margin:0">Current schedules</h3>
          <button class="btn ghost" id="refreshScheduleBtn">Refresh</button>
        </div>
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Device</th>
              <th>Time</th>
              <th>Repeat</th>
              <th>Amount (g)</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="scRows"></tbody>
        </table>
      </div>
    </main>
  </div>

  <script>
    // ====== CONFIG ======
    const FETCH_N = 300;
    const FEED_NOW_API  = '/control/feed-now';
    const SCHEDULE_API  = '/control/schedule';
    const SCHEDULES_API = '/control/schedules';
    const LATEST_API    = `/dashboard/latest?n=${FETCH_N}`;

    // ====== STATE ======
    let devices = [];

    // ====== HELPERS ======
    const byTimeAsc = (a,b)=> new Date(a.ts) - new Date(b.ts);
    function fillDeviceSelects(list){
      const idSet = new Set(list.map(x => (x.deviceId || x.device_id || '').trim()).filter(Boolean));
      devices = Array.from(idSet).sort();
      const fn = document.getElementById('fnDevice');
      const sc = document.getElementById('scDevice');
      fn.innerHTML = ''; sc.innerHTML = '';
      devices.forEach(id=>{
        const o1=document.createElement('option'); o1.value=o1.textContent=id; fn.appendChild(o1);
        const o2=document.createElement('option'); o2.value=o2.textContent=id; sc.appendChild(o2);
      });
      if (!devices.length){
        const opt=document.createElement('option'); opt.value=''; opt.textContent='(no devices)';
        fn.appendChild(opt.cloneNode(true)); sc.appendChild(opt);
      }
    }

    // ====== DOUGHNUT HELPERS ======
    const pieCharts = {};
    function ensureFeedPie(canvasId){
      if (pieCharts[canvasId]) return pieCharts[canvasId];
      const el = document.getElementById(canvasId);
      if (!el) return null;
      const ctx = el.getContext('2d');
      pieCharts[canvasId] = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Remaining','Used'],
          datasets: [{ data:[0,100], backgroundColor:['#4f46e5','#e8eefb'], borderWidth:0, hoverOffset:3, cutout:'65%' }]
        },
        options: { plugins:{ legend:{ display:false } }, animation:{ duration:300 } }
      });
      return pieCharts[canvasId];
    }
    function setPie(canvasId, percent, numId, timeId, warnId, ts){
      const chart = ensureFeedPie(canvasId);
      if (!chart) return;
      const clamp = v => Math.max(0, Math.min(100, Number(v)));
      const p = isNaN(percent) ? NaN : clamp(percent);
      if (isNaN(p)){
        chart.data.datasets[0].data = [0,100];
        chart.data.datasets[0].backgroundColor = ['#4f46e5','#e8eefb'];
        chart.update();
        document.getElementById(numId).textContent = '--%';
        document.getElementById(timeId).textContent = '—';
        document.getElementById(warnId).style.display = 'none';
        return;
      }
      const used = 100 - p;
      let color = '#4f46e5'; if (p<10) color='#dc2626'; else if (p<30) color='#d97706';
      chart.data.datasets[0].data = [p,used];
      chart.data.datasets[0].backgroundColor = [color,'#e8eefb'];
      chart.update();

      document.getElementById(numId).textContent = `${p.toFixed(1)}%`;
      const d = new Date(ts);
      document.getElementById(timeId).textContent = isNaN(d) ? (ts||'') : d.toLocaleTimeString();
      document.getElementById(warnId).style.display = (p<10)?'inline-block':'none';
    }
    function updateLastTwoPies(sortedAsc){
      const withFeed = sortedAsc.filter(x => x.feed != null);
      const n = withFeed.length;
      const last1 = n>=1 ? withFeed[n-1] : null;
      const last2 = n>=2 ? withFeed[n-2] : null;
      if (last1) setPie('feedPie1', Number(last1.feed), 'feedPie1Num', 'feedPie1Time', 'feedPie1Warn', last1.ts);
      else       setPie('feedPie1', NaN, 'feedPie1Num', 'feedPie1Time', 'feedPie1Warn');
      if (last2) setPie('feedPie2', Number(last2.feed), 'feedPie2Num', 'feedPie2Time', 'feedPie2Warn', last2.ts);
      else       setPie('feedPie2', NaN, 'feedPie2Num', 'feedPie2Time', 'feedPie2Warn');
    }

    // ====== LOAD SERIES (for pies + device selects) ======
    async function loadFeedSeries(){
      const r = await fetch(LATEST_API);
      if (!r.ok) throw new Error('HTTP '+r.status);
      const j = await r.json();
      const items = (j.items||[]);
      fillDeviceSelects(items);

      // chuẩn hoá feed + ts, sort tăng rồi cập nhật 2 doughnut
      const arr = items
        .map(x => ({ ts:x.ts, feed:(x.feed_amount ?? x.feed), deviceId:(x.deviceId||x.device_id||'') }))
        .filter(x => x.ts)
        .sort(byTimeAsc)
        .slice(-200);
      updateLastTwoPies(arr);
    }

    // ====== FEED NOW ======
    document.getElementById('feedNowBtn').onclick = async ()=>{
      const device = document.getElementById('fnDevice').value;
      const amount = Number(document.getElementById('fnAmount').value || 0);
      const msg = document.getElementById('feedNowMsg');
      if (!device || amount<=0){ msg.textContent='Please choose device & valid amount.'; return; }
      msg.textContent = 'Sending...';
      try{
        const r = await fetch(FEED_NOW_API, { method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ device_id: device, amount }) });
        const j = await r.json();
        if (!r.ok || j.error) throw new Error(j.error || ('HTTP '+r.status));
        msg.textContent = 'Feed command queued.';
      }catch(e){ msg.textContent = 'Failed: ' + e.message; }
      finally{ setTimeout(()=>msg.textContent='', 3000); }
    };

    // ====== SCHEDULE CRUD ======
    async function refreshSchedules(){
      const tbody = document.getElementById('scRows');
      tbody.innerHTML = '<tr><td colspan="6" class="muted">Loading…</td></tr>';
      try{
        const r = await fetch(SCHEDULES_API);
        const j = await r.json();
        const list = j.items || [];
        tbody.innerHTML = '';
        list.forEach((s,idx)=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${idx+1}</td>
            <td>${s.device_id || s.deviceId || ''}</td>
            <td>${s.time || ''}</td>
            <td>${s.repeat || 'once'}</td>
            <td>${s.amount ?? ''}</td>
            <td><button class="btn ghost" onclick="deleteSchedule('${s.id}')">Delete</button></td>`;
          tbody.appendChild(tr);
        });
        if (!list.length) tbody.innerHTML = '<tr><td colspan="6" class="muted">No schedules.</td></tr>';
      }catch(e){
        tbody.innerHTML = `<tr><td colspan="6" class="muted">Load failed: ${e.message}</td></tr>`;
      }
    }
    async function addSchedule(){
      const device = document.getElementById('scDevice').value;
      const time   = document.getElementById('scTime').value;
      const repeat = document.getElementById('scRepeat').value;
      const amount = Number(document.getElementById('scAmount').value || 0);
      const msg = document.getElementById('addScheduleMsg');
      if (!device || !time || amount<=0){ msg.textContent='Please fill all fields.'; return; }
      msg.textContent = 'Creating…';
      try{
        const r = await fetch(SCHEDULE_API, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ device_id: device, time, repeat, amount })
        });
        const j = await r.json();
        if (!r.ok || j.error) throw new Error(j.error || ('HTTP '+r.status));
        msg.textContent = 'Added.'; await refreshSchedules();
      }catch(e){ msg.textContent = 'Failed: ' + e.message; }
      finally{ setTimeout(()=>msg.textContent='', 2500); }
    }
    document.getElementById('addScheduleBtn').onclick = addSchedule;
    document.getElementById('refreshScheduleBtn').onclick = refreshSchedules;
    async function deleteSchedule(id){
      if (!confirm('Delete this schedule?')) return;
      try{
        const r = await fetch(`${SCHEDULES_API}/${encodeURIComponent(id)}`, { method:'DELETE' });
        const j = await r.json();
        if (!r.ok || j.error) throw new Error(j.error || ('HTTP '+r.status));
        refreshSchedules();
      }catch(e){ alert('Delete failed: '+e.message); }
    }
    window.deleteSchedule = deleteSchedule;

    // ====== INIT ======
    (async function init(){
      try{
        await loadFeedSeries();
        await refreshSchedules();
        setInterval(loadFeedSeries, 15000); // refresh pies
      }catch(e){
        console.error(e); alert('Init failed: '+e.message);
      }
    })();
  </script>
</body>
</html>
